<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Martha's Vineyard Climate Risk Patterns</title>
    <link rel="stylesheet" href="../static/css/styles.css">
</head>
<body>
    <div id="visualization-container">
        <div id="network-container"></div>
        
        <!-- Controls -->
        <div class="controls">
            <button class="control-button" id="toggle-labels">Toggle Labels</button>
            <button class="control-button" id="reset-zoom">Reset Zoom</button>
            <button class="control-button" id="export-graph">Export Graph</button>
        </div>
        
        <!-- Stage selector -->
        <div class="stage-selector">
            <button class="stage-button active" data-stage="all">All Patterns</button>
            <button class="stage-button" data-stage="stage1">Precipitation</button>
            <button class="stage-button" data-stage="stage2">Drought</button>
            <button class="stage-button" data-stage="stage3">Wildfire</button>
        </div>

        <!-- Tooltip -->
        <div id="tooltip"></div>
        
        <!-- Error box -->
        <div id="error-box" class="error-box"></div>
        
        <!-- Metrics Panel -->
        <div class="metrics-panel">
            <div class="metric-card">
                <div class="metric-title">Pattern Stability</div>
                <div id="stability-value" class="metric-value">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Pattern Coherence</div>
                <div id="coherence-value" class="metric-value">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Energy State</div>
                <div id="energy-value" class="metric-value">-</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="../static/js/network.js"></script>
    <script src="../static/js/websocket.js"></script>
    
    <script>
        // Initialize WebSocket connection
        const wsManager = new WebSocketManager();
        const network = new NetworkGraph('network-container');
        
        // Handle incoming messages
        wsManager.onMessage = (data) => {
            console.log('Received data:', data);
            
            // Update network visualization
            network.update(data.state, null);
            
            // Update metrics
            if (data.state && data.state.metadata) {
                document.getElementById('stability-value').textContent = 
                    (data.state.metadata.stability * 100).toFixed(1) + '%';
                document.getElementById('coherence-value').textContent = 
                    (data.state.metadata.coherence * 100).toFixed(1) + '%';
                document.getElementById('energy-value').textContent = 
                    (data.state.metadata.energy_state * 100).toFixed(1) + '%';
            }
        };
        
        // Handle stage selection
        document.querySelectorAll('.stage-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.stage-button').forEach(b => b.classList.remove('active'));
                button.classList.add('active');
                network.update(null, button.dataset.stage);
            });
        });
        
        // Handle controls
        document.getElementById('toggle-labels').addEventListener('click', () => network.toggleLabels());
        document.getElementById('reset-zoom').addEventListener('click', () => network.resetZoom());
        document.getElementById('export-graph').addEventListener('click', () => network.exportGraph());
    </script>
</body>
</html>
